{% extends "base.html" %}

{% block title %}Curadoria de Imagens - AquaFlora Stock Sync{% endblock %}

{% block content %}
<div class="dashboard images-page">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-text">
            <h1>üì∏ Curadoria de Imagens</h1>
            <p class="muted">Selecione um produto, escolha a melhor imagem e avance rapidamente.</p>
        </div>
        <div class="quick-actions">
            <div class="search-mode">
                <label for="search-mode">Modo:</label>
                <select id="search-mode" onchange="setSearchMode(this.value)">
                    <option value="premium">Premium</option>
                    <option value="cheap">Cheap</option>
                    <option value="auto">Auto</option>
                </select>
            </div>
            <span class="stats-badge">
                <strong>{{ stats.pending_count | default(0) }}</strong> pendentes
            </span>
            <span class="stats-badge success">
                <strong>{{ stats.curated_count | default(0) }}</strong> curadas
            </span>
        </div>
    </header>

    <!-- Indicador de loading -->
    <div id="loading" class="htmx-indicator">
        <div class="spinner"></div>
        <span>Buscando imagens...</span>
    </div>

    <!-- Resultado de a√ß√µes -->
    <div id="action-result"></div>

    <!-- Layout principal: sidebar + main -->
    <div class="images-layout">
        <!-- Sidebar: Lista de produtos pendentes -->
        <aside class="images-sidebar card">
            <div class="card-header">
                <h2>üìã Pendentes</h2>
                <div class="sidebar-actions">
                    <button class="btn btn-sm" hx-get="/partials/pending-list" hx-target="#pending-list">
                        üîÑ
                    </button>
                </div>
            </div>
            <div class="sidebar-search">
                <input id="pending-search" class="form-control" placeholder="Buscar SKU ou nome" oninput="filterPending()">
                <label class="checkbox-label checkbox-inline">
                    <input type="checkbox" id="pending-only-unchecked" onchange="filterPending()">
                    <span>Somente n√£o curados</span>
                </label>
            </div>
            <div class="card-body" id="pending-list" hx-get="/partials/pending-list" hx-trigger="load">
                <!-- Lista carregada via HTMX -->
                <div class="loading-placeholder">Carregando...</div>
            </div>
        </aside>

        <!-- Main: Grid de candidatos -->
        <main class="images-main card">
            <div class="card-header">
                <div class="product-header">
                    <h2 id="current-product-title">Selecione um produto</h2>
                    <p id="current-product-subtitle" class="muted"></p>
                </div>
                <div class="product-actions" id="product-actions" style="display: none;">
                    <button class="btn btn-sm" id="copy-sku-btn" onclick="copySku()">
                        üìã Copiar SKU
                    </button>
                    <button class="btn btn-sm" id="skip-btn" onclick="skipProduct()">
                        ‚è≠Ô∏è Pular
                    </button>
                    <button class="btn btn-sm btn-secondary" id="family-btn" onclick="applyToFamily()">
                        üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Aplicar p/ Fam√≠lia
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="image-candidates" class="image-grid">
                    <div class="empty-state">
                        <p>üëÜ Selecione um produto na lista √† esquerda</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
    let currentSku = null;
    let currentProductName = null;
    let searchMode = localStorage.getItem('imageSearchMode') || 'cheap';

    document.addEventListener('DOMContentLoaded', () => {
        const select = document.getElementById('search-mode');
        if (select) {
            select.value = searchMode;
        }
    });

    function setSearchMode(mode) {
        searchMode = mode;
        localStorage.setItem('imageSearchMode', mode);
    }

    function selectProduct(sku, productName) {
        currentSku = sku;
        currentProductName = productName;

        // Update title
        document.getElementById('current-product-title').textContent =
            `${productName || 'Produto selecionado'}`;
        document.getElementById('current-product-subtitle').textContent =
            `SKU: ${sku}`;

        // Show actions
        document.getElementById('product-actions').style.display = 'flex';

        // Highlight selected item
        document.querySelectorAll('.pending-item').forEach(el => {
            el.classList.remove('active');
        });
        document.querySelector(`[data-sku="${sku}"]`)?.classList.add('active');

        // Load candidates
        htmx.ajax('GET', `/api/images/search/${sku}?mode=${encodeURIComponent(searchMode)}`, {
            target: '#image-candidates',
            indicator: '#loading'
        });
    }

    function selectImage(imageUrl) {
        if (!currentSku) return;

        // Send selection
        fetch('/api/images/select', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `sku=${encodeURIComponent(currentSku)}&image_url=${encodeURIComponent(imageUrl)}`
        })
            .then(response => response.text())
            .then(html => {
                document.getElementById('action-result').innerHTML = html;
                // Refresh pending list
                htmx.ajax('GET', '/partials/pending-list', { target: '#pending-list' });
                // Clear current selection
                document.getElementById('image-candidates').innerHTML =
                    '<div class="empty-state"><p>‚úÖ Imagem salva! Selecione outro produto.</p></div>';
                document.getElementById('product-actions').style.display = 'none';
                document.getElementById('current-product-subtitle').textContent = '';
                currentSku = null;
            });
    }

    function skipProduct() {
        if (!currentSku) return;

        // Just move to next without saving
        document.getElementById('image-candidates').innerHTML =
            '<div class="empty-state"><p>‚è≠Ô∏è Produto pulado. Selecione outro.</p></div>';
        document.getElementById('product-actions').style.display = 'none';
        document.getElementById('current-product-subtitle').textContent = '';
        currentSku = null;
    }

    function applyToFamily() {
        if (!currentSku) return;

        fetch('/api/images/apply-family', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `sku=${encodeURIComponent(currentSku)}`
        })
            .then(response => response.text())
            .then(html => {
                document.getElementById('action-result').innerHTML = html;
                // Refresh pending list
                htmx.ajax('GET', '/partials/pending-list', { target: '#pending-list' });
            });
    }

    function copySku() {
        if (!currentSku) return;
        navigator.clipboard?.writeText(currentSku);
    }

    function filterPending() {
        const query = document.getElementById('pending-search').value.trim().toLowerCase();
        const onlyUnchecked = document.getElementById('pending-only-unchecked').checked;
        document.querySelectorAll('.pending-item').forEach((item) => {
            const text = item.textContent.toLowerCase();
            const matchesQuery = !query || text.includes(query);
            const matchesUnchecked = !onlyUnchecked || !item.classList.contains('curated');
            item.style.display = matchesQuery && matchesUnchecked ? 'block' : 'none';
        });
    }
</script>

<style>
    .images-page {
        max-width: 1400px;
    }

    .images-layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .images-sidebar {
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }

    .images-sidebar .card-body {
        padding: 0;
    }

    .sidebar-search {
        padding: 0.75rem 1rem 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .product-header {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .pending-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: background 0.2s;
    }

    .pending-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .pending-item.active {
        background: rgba(16, 185, 129, 0.2);
        border-left: 3px solid #10B981;
    }

    .pending-item .sku {
        font-family: monospace;
        font-weight: 600;
        color: #10B981;
    }

    .pending-item .name {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 1rem;
    }

    .image-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .image-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
    }

    .image-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
    }

    .image-card .meta {
        padding: 0.5rem;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 3rem;
        color: rgba(255, 255, 255, 0.5);
    }

    .stats-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
    }

    .stats-badge.success {
        background: rgba(16, 185, 129, 0.2);
        color: #10B981;
    }

    .product-actions {
        display: flex;
        gap: 0.5rem;
    }

    @media (max-width: 768px) {
        .images-layout {
            grid-template-columns: 1fr;
        }

        .images-sidebar {
            max-height: 200px;
        }
    }

    .search-mode {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .search-mode select {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        padding: 0.3rem 0.5rem;
    }
</style>
{% endblock %}